pipeline {
    agent { 
        label 'python-static-agent' 
    }

    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key')
        REGION                = "ap-south-1"
        CLUSTER_NAME          = "demo-eks-cluster"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Cleanup App & ALB') {
            steps {
                script {
                    echo "--- Connecting to Cluster ---"
                    // Fails safely if cluster is already gone
                    try {
                        sh "aws eks update-kubeconfig --region ${REGION} --name ${CLUSTER_NAME}"
                        
                        echo "--- Deleting Ingress/Services ---"
                        // This triggers the AWS Load Balancer Controller to delete the real ALB
                        sh 'kubectl delete -f k8s/ --ignore-not-found=true'
                        
                        echo "--- Waiting for ALB Destruction ---"
                        echo "Sleeping 3 minutes to ensure AWS releases the Network Interfaces..."
                        sleep 180 
                    } catch (Exception e) {
                        echo "Cluster might already be deleted or unreachable. Proceeding to Terraform destroy..."
                    }
                }
            }
        }

        stage('Terraform Destroy') {
            // We switch to the Terraform container for the infrastructure destruction
            agent {
                docker {
                    image 'hashicorp/terraform:light'
                    args '-u root:root'
                }
            }
            steps {
                dir('terraform') {
                    // We must init again to get the state from S3
                    sh 'terraform init'
                    
                    // The actual destruction command
                    sh 'terraform destroy -auto-approve'
                }
            }
        }
    }
}
