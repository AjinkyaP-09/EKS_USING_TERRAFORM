pipeline {
    agent {
        // Run directly on the agent
        label 'python-static-agent'
    }

    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key')
        REGION                = "ap-south-1"
        CLUSTER_NAME          = "demo-eks-cluster"
        PATH                  = "${WORKSPACE}/bin:${PATH}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup Tools') {
            steps {
                script {
                    sh '''
                        mkdir -p ${WORKSPACE}/bin
                        
                        echo "--- Installing AWS CLI ---"
                        # Only install if not present to save time
                        if [ ! -d "${WORKSPACE}/aws-cli" ]; then
                            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                            unzip -q -o awscliv2.zip
                            ./aws/install -i ${WORKSPACE}/aws-cli -b ${WORKSPACE}/bin || true
                        fi
                        
                        echo "--- Installing Kubectl ---"
                        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                        # FIX: chmod the local file first, THEN move it
                        chmod +x ./kubectl
                        mv ./kubectl ${WORKSPACE}/bin/
                        
                        echo "--- Installing Helm ---"
                        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
                        chmod 700 get_helm.sh
                        HELM_INSTALL_DIR=${WORKSPACE}/bin ./get_helm.sh --no-sudo
                    '''
                }
            }
        }

        stage('Connect to Cluster') {
            steps {
                sh "aws eks update-kubeconfig --region ${REGION} --name ${CLUSTER_NAME}"
            }
        }
        
        stage('Install ALB Controller') {
            steps {
                script {
                   try {
                     sh 'helm repo add eks https://aws.github.io/eks-charts'
                     sh 'helm repo update'
                     
                     // ADDED: --atomic to automatically rollback if it fails
                     // ADDED: --force to overwrite potential conflicts from broken installs
                     sh '''
                       helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
                       -n kube-system \
                       --set clusterName=demo-eks-cluster \
                       --set serviceAccount.create=true \
                       --set serviceAccount.name=aws-load-balancer-controller \
                       --set serviceAccount.annotations."eks\\.amazonaws\\.com/role-arn"="arn:aws:iam::022499018754:role/eks-alb-controller-role" \
                       --force \
                       --atomic
                     '''
                     
                     echo "--- Waiting for AWS Load Balancer Controller to be Ready ---"
                     // This pauses pipeline until the controller pods are actually running
                     sh 'kubectl rollout status deployment/aws-load-balancer-controller -n kube-system --timeout=300s'
                     
                   } catch (Exception e) {
                       echo "Helm install failed: ${e}"
                       
                       // DEBUG BLOCK: If it fails, print logs so we can see WHY
                       echo "--- DEBUG: Fetching Pod Status ---"
                       sh 'kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller'
                       
                       echo "--- DEBUG: Fetching Controller Logs ---"
                       sh 'kubectl logs -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller --tail=50 || true'
                       
                       echo "--- DEBUG: Describing Pods ---"
                       sh 'kubectl describe pods -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller || true'
                       
                       error("Pipeline failed due to Helm Controller installation issues.")
                   }
                }
            }
        }

        stage('Deploy 3-Tier App') {
            steps {
                // This sends your yaml to the cluster
                sh 'kubectl apply -f k8s/app.yaml'
            }
        }

        stage('Verify') {
            steps {
                sh 'kubectl get pods'
                sh 'kubectl get ingress'
                echo "Wait 2-3 minutes for the 'ADDRESS' column in 'kubectl get ingress' to show your Load Balancer URL."
            }
        }
    }
}
