pipeline {
    agent {
        // We run directly on the agent, NOT inside another container
        label 'python-static-agent'
    }

    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws-access-key')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key')
        REGION                = "ap-south-1"
        CLUSTER_NAME          = "demo-eks-cluster"
        // Add local bin to PATH so we can run the tools we install
        PATH                  = "${WORKSPACE}/bin:${PATH}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup Tools') {
            steps {
                // Install tools locally to avoid Docker-in-Docker volume issues
                script {
                    sh '''
                        mkdir -p ${WORKSPACE}/bin
                        
                        echo "--- Installing AWS CLI ---"
                        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                        unzip -q awscliv2.zip
                        ./aws/install -i ${WORKSPACE}/aws-cli -b ${WORKSPACE}/bin || true
                        
                        echo "--- Installing Kubectl ---"
                        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                        chmod +x kubectl
                        mv kubectl ${WORKSPACE}/bin/
                        
                        echo "--- Installing Helm ---"
                        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
                        chmod 700 get_helm.sh
                        HELM_INSTALL_DIR=${WORKSPACE}/bin ./get_helm.sh --no-sudo
                    '''
                }
            }
        }

        stage('Connect to Cluster') {
            steps {
                sh "aws eks update-kubeconfig --region ${REGION} --name ${CLUSTER_NAME}"
            }
        }
        
        stage('Install ALB Controller') {
            steps {
                script {
                   try {
                     sh 'helm repo add eks https://aws.github.io/eks-charts'
                     sh 'helm repo update'
                     
                     sh '''
                       helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
                       -n kube-system \
                       --set clusterName=demo-eks-cluster \
                       --set serviceAccount.create=true \
                       --set serviceAccount.name=aws-load-balancer-controller
                     '''
                   } catch (Exception e) {
                       echo "Helm install failed or already exists: ${e}"
                   }
                }
            }
        }

        stage('Deploy 3-Tier App') {
            steps {
                sh 'kubectl apply -f k8s/'
            }
        }

        stage('Verify') {
            steps {
                sh 'kubectl get pods'
                sh 'kubectl get ingress'
            }
        }
    }
}
